name: Build and Push Docker Images

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: docker.io
  NAMESPACE: zyg5467

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64
        
    - name: Debug Docker Hub credentials
      run: |
        echo "Checking DockerHub credentials..."
        if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
          echo "ERROR: DOCKERHUB_USERNAME secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "ERROR: DOCKERHUB_TOKEN secret is not set"
          exit 1
        fi
        echo "DockerHub username: ${{ secrets.DOCKERHUB_USERNAME }}"
        echo "DockerHub token is set: $(if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then echo 'YES'; else echo 'NO'; fi)"
        
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Install Python and hatch
      run: |
        python -m pip install --upgrade pip
        python -m pip install hatch
        
    - name: Build and distribute commons library  
      run: |
        echo "ðŸ”¨ Building commons library using project build scripts..."
        
        # Step 1: Build commons using run_build_common.sh
        if [ -f "./scripts/run_build_common.sh" ]; then
          echo "ðŸ“‹ Building commons package..."
          chmod +x ./scripts/run_build_common.sh
          ./scripts/run_build_common.sh
        else
          echo "âŒ run_build_common.sh not found"
          exit 1
        fi
        
        # Step 2: Copy commons to all services using run_copy_common.sh
        if [ -f "./scripts/run_copy_common.sh" ]; then
          echo "ðŸ“‹ Copying commons to all services..."
          chmod +x ./scripts/run_copy_common.sh
          ./scripts/run_copy_common.sh
        else
          echo "âŒ run_copy_common.sh not found"
          exit 1
        fi
        
        # Step 3: Update Pipfiles with new version
        echo "ðŸ“‹ Updating service Pipfiles with new commons version..."
        COMMONS_DIST_DIR="./services/commons/dist"
        LATEST_WHEEL=$(ls -t "$COMMONS_DIST_DIR"/kugel_common-*-py3-none-any.whl 2>/dev/null | head -n 1)
        
        if [ -n "$LATEST_WHEEL" ]; then
          WHEEL_FILENAME=$(basename "$LATEST_WHEEL")
          VERSION=$(echo "$WHEEL_FILENAME" | cut -d'-' -f2)
          echo "  Latest version: $VERSION"
          
          # Update each service's Pipfile
          SERVICES=(account terminal master-data cart report journal stock)
          for service in "${SERVICES[@]}"; do
            PIPFILE="./services/$service/Pipfile"
            if [ -f "$PIPFILE" ]; then
              # Update Pipfile with new version
              sed -i "s|kugel_common = {file = \"commons/dist/kugel_common-[0-9.]*-py3-none-any\\.whl\"}|kugel_common = {file = \"commons/dist/kugel_common-${VERSION}-py3-none-any.whl\"}|" "$PIPFILE"
              echo "  âœ… Updated $service Pipfile"
            fi
          done
        else
          echo "âŒ No commons wheel file found"
          exit 1
        fi
        
        echo "ðŸ“‹ Verifying commons distribution:"
        for service in account terminal master-data cart report journal stock; do
          if [ -d "./services/$service/commons/dist" ]; then
            echo "  âœ… $service: $(ls -la ./services/$service/commons/dist/ | wc -l) files"
          else
            echo "  âŒ $service: commons/dist directory not found"
          fi
        done
        
    - name: Build and push all Docker images
      id: build-images
      run: |
        SERVICES="account terminal master-data cart report journal stock"
        
        # Build and push each service
        for service in $SERVICES; do
          echo "ðŸš€ Building and pushing $service..."
          
          # Check if service directory exists
          if [ ! -d "./services/$service" ]; then
            echo "âŒ Service directory ./services/$service not found"
            exit 1
          fi
          
          echo "ðŸ“‚ Contents of ./services/$service:"
          ls -la ./services/$service
          
          # Check if commons is available
          if [ -d "./services/$service/commons/dist" ]; then
            echo "âœ… Commons found for $service:"
            ls -la ./services/$service/commons/dist/
          else
            echo "âš ï¸  No commons dist found for $service"
          fi
          
          # Check if Dockerfile exists
          if [ ! -f "./services/$service/Dockerfile" ]; then
            echo "âŒ Dockerfile not found for $service"
            exit 1
          fi
          
          # Build and push image with better error handling
          echo "ðŸ”¨ Building Docker image for $service..."
          if docker buildx build \
            --platform linux/amd64 \
            --push \
            --tag ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/pos-$service:latest \
            ./services/$service; then
            echo "âœ… Successfully built $service"
          else
            echo "âŒ Failed to build $service"
            exit 1
          fi
            
          # Get the digest with retry
          echo "ðŸ“‹ Getting digest for $service..."
          DIGEST=""
          for attempt in 1 2 3; do
            DIGEST=$(docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/pos-$service:latest --format '{{.Manifest.Digest}}' 2>/dev/null || echo "")
            if [ -n "$DIGEST" ]; then
              break
            fi
            echo "â³ Attempt $attempt failed, retrying in 5 seconds..."
            sleep 5
          done
          
          if [ -z "$DIGEST" ]; then
            echo "âŒ Failed to get digest for $service"
            exit 1
          fi
          
          # Save digest to output
          echo "${service//-/_}_digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… Built $service with digest: $DIGEST"
        done
        
    - name: Update docker-compose.yaml with SHA256 digests
      run: |
        # Set environment variables for the update script
        export ACCOUNT_DIGEST="${{ steps.build-images.outputs.account_digest }}"
        export TERMINAL_DIGEST="${{ steps.build-images.outputs.terminal_digest }}"
        export MASTER_DATA_DIGEST="${{ steps.build-images.outputs.master_data_digest }}"
        export CART_DIGEST="${{ steps.build-images.outputs.cart_digest }}"
        export REPORT_DIGEST="${{ steps.build-images.outputs.report_digest }}"
        export JOURNAL_DIGEST="${{ steps.build-images.outputs.journal_digest }}"
        export STOCK_DIGEST="${{ steps.build-images.outputs.stock_digest }}"
        
        # Run the update script
        chmod +x ./scripts/update_compose_digests.sh
        ./scripts/update_compose_digests.sh --use-env
        
    - name: Commit and push updated docker-compose.yaml
      run: |
        cd services
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docker-compose.yaml
        
        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update docker-compose.yaml with latest image SHA256 digests" \
                     -m "" \
                     -m "ðŸ¤– Generated by GitHub Actions" \
                     -m "" \
                     -m "- account: ${{ steps.build-images.outputs.account_digest }}" \
                     -m "- terminal: ${{ steps.build-images.outputs.terminal_digest }}" \
                     -m "- master-data: ${{ steps.build-images.outputs.master_data_digest }}" \
                     -m "- cart: ${{ steps.build-images.outputs.cart_digest }}" \
                     -m "- report: ${{ steps.build-images.outputs.report_digest }}" \
                     -m "- journal: ${{ steps.build-images.outputs.journal_digest }}" \
                     -m "- stock: ${{ steps.build-images.outputs.stock_digest }}"
          git push
        fi