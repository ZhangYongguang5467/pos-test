name: Test Single Service Build

on:
  workflow_dispatch:

env:
  REGISTRY: docker.io
  NAMESPACE: zyg5467

jobs:
  test-single-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Install hatch
      run: |
        python -m pip install --upgrade pip
        python -m pip install hatch
        
    - name: Test commons build
      run: |
        echo "ğŸ”¨ Testing commons build process..."
        
        cd services/commons
        echo "ğŸ“‚ Current directory: $(pwd)"
        echo "ğŸ“‹ Files:"
        ls -la
        
        echo "ğŸ“‹ Building commons with run_build.sh..."
        if [ -f "run_build.sh" ]; then
          chmod +x run_build.sh
          ./run_build.sh
          echo "âœ… Build completed"
          echo "ğŸ“‹ Build output:"
          ls -la dist/ || echo "No dist directory"
        else
          echo "âŒ run_build.sh not found"
          exit 1
        fi
        
    - name: Test commons copy
      run: |
        cd services/commons
        echo "ğŸ”„ Testing commons copy to account service..."
        
        if [ -f "run_copy.sh" ]; then
          chmod +x run_copy.sh
          ./run_copy.sh account
          echo "âœ… Copy completed"
          
          echo "ğŸ“‹ Checking copy result:"
          if [ -d "../account/commons/dist" ]; then
            ls -la ../account/commons/dist/
          else
            echo "âŒ Copy failed - no dist directory found"
            exit 1
          fi
        else
          echo "âŒ run_copy.sh not found"
          exit 1
        fi
        
    - name: Test single Docker build
      run: |
        echo "ğŸ³ Testing Docker build for account service..."
        
        SERVICE="account"
        IMAGE_NAME="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/pos-$SERVICE:test"
        
        echo "ğŸ“‚ Checking service directory:"
        ls -la ./services/$SERVICE
        
        echo "ğŸ“‹ Checking Dockerfile:"
        cat ./services/$SERVICE/Dockerfile
        
        echo "ğŸ”¨ Building Docker image..."
        docker build \
          --tag $IMAGE_NAME \
          ./services/$SERVICE
          
        echo "âœ… Build successful!"
        
        echo "ğŸ“‹ Image info:"
        docker images $IMAGE_NAME
        
        echo "ğŸš€ Testing push..."
        docker push $IMAGE_NAME
        
        echo "ğŸ“‹ Getting digest..."
        DIGEST=$(docker manifest inspect $IMAGE_NAME | jq -r '.digest')
        echo "Image digest: $DIGEST"