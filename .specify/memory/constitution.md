# Kugelpos プロジェクト憲章

<!--
Sync Impact Report:
- Version: 1.0.1 (PATCH: コード品質ツールの現状と移行計画を明確化)
- Modified principles: なし（明確化のみ）
- Added sections: なし
- Removed sections: なし
- Templates requiring updates:
  ✅ spec-template.md (影響なし)
  ✅ plan-template.md (影響なし)
  ✅ tasks-template.md (影響なし)
  ✅ checklist-template.md (影響なし)
- Follow-up TODOs:
  - ruff への移行計画策定（タイムライン、影響範囲評価）
  - サービスごとの段階的移行（テストカバレッジ維持）
  - CI/CD パイプラインの更新

Previous versions:
- 1.0.0 (2025-10-12): 初版作成
-->

## コアプリンシプル

### I. マイクロサービス独立性

**原則**: 各マイクロサービスは独立して開発、テスト、デプロイ可能でなければならない。

- 各サービスは独自のデータベース（MongoDB コレクション/データベース）を持つ
- サービス間の直接的なデータベースアクセスは禁止
- サービス間通信は Dapr を介したイベント駆動またはAPI呼び出しのみ
- 共通ライブラリ（commons）は純粋なユーティリティのみ（ビジネスロジックを含まない）
- 各サービスは独立してテスト実行可能（他サービスのモック化が容易）

**根拠**: マイクロサービスアーキテクチャの利点（スケーラビリティ、独立デプロイ、障害分離）を最大化するため。

### II. 非同期優先 (Async-First)

**原則**: すべてのI/O操作は非同期で実装しなければならない。

- データベース操作は Motor (async MongoDB driver) を使用
- HTTP クライアント呼び出しは async/await パターンを使用
- FastAPI のエンドポイントは async def で定義
- ブロッキング操作は ThreadPoolExecutor で非同期化
- 同期的な実装は明示的な理由がある場合のみ許可（ドキュメント化必須）

**根拠**: FastAPI の性能を最大化し、高いスループットと低レイテンシーを実現するため。

### III. テスト駆動開発 (TDD - 必須)

**原則**: すべての新機能はテストファーストで開発しなければならない。

- **Red-Green-Refactor サイクル**: テスト作成 → 失敗確認 → 実装 → 成功確認 → リファクタリング
- テストカバレッジ目標: 最低80%（重要なビジネスロジックは90%以上）
- テストファイルパターン: `test_*.py`
- テスト実行順序: `test_clean_data.py` → `test_setup_data.py` → 機能テスト
- 各サービスは独立したテストスイートを持つ
- pytest-asyncio を使用した非同期テスト
- モックは必要最小限（実際の統合テストを優先）

**根拠**: コードの品質保証、リファクタリングの安全性確保、ドキュメントとしての機能提供のため。

### IV. イベント駆動アーキテクチャ

**原則**: サービス間の通信はイベント駆動パターンを優先しなければならない。

- **Dapr Pub/Sub** を使用した非同期メッセージング
- 定義済みトピック:
  - `tranlog_report`: トランザクションデータ（レポート用）
  - `tranlog_status`: トランザクションステータス更新
  - `cashlog_report`: 現金入出金イベント
  - `opencloselog_report`: ターミナル開閉イベント
- イベントスキーマはバージョニング必須
- 各イベントにはトレーシングID（相関ID）を含める
- イベント処理の冪等性を保証（重複配信に対応）
- デッドレターキュー (DLQ) の実装

**根拠**: サービス間の疎結合を実現し、システムの拡張性と保守性を向上させるため。

### V. 回復力とエラーハンドリング (Resilience)

**原則**: すべての外部依存に対して回復力パターンを実装しなければならない。

- **Circuit Breaker Pattern**:
  - 失敗閾値: 3回連続失敗でオープン
  - タイムアウト: 60秒後に半開状態へ遷移
  - 適用対象: HTTP呼び出し、Dapr State Store、Dapr Pub/Sub
- **Retry Pattern**:
  - 指数バックオフを使用（初回: 1秒、2回目: 2秒、3回目: 4秒...）
  - 最大リトライ回数: 3回
  - リトライ可能なエラーのみ対象（4xx系エラーはリトライしない）
- **Timeout Pattern**:
  - すべての外部呼び出しにタイムアウト設定必須
  - デフォルト: HTTP 30秒、データベース 10秒
- エラーコード体系: XXYYZZ形式
  - XX: サービス識別子（10=account, 20=terminal, 30=cart...）
  - YY: 機能/モジュール識別子
  - ZZ: 具体的エラー番号

**根拠**: 一時的な障害に対する耐性を持たせ、システム全体の可用性を向上させるため。

### VI. マルチテナンシー（厳格な分離）

**原則**: テナント間のデータ分離は厳格に実装しなければならない。

- **データベースレベル分離**: 各テナントは独立した MongoDB データベースを持つ
- データベース名パターン: `{service_name}_{tenant_code}`
- すべてのAPI呼び出しで tenant_code を検証
- ターミナルAPI認証には API キー（ハッシュ化して保存）を使用
- クロステナントアクセスは明示的に禁止
- テスト環境でもテナント分離を維持

**根拠**: データセキュリティとプライバシーを確保し、規制要件（個人情報保護法等）に準拠するため。

### VII. 可観測性 (Observability)

**原則**: すべてのサービスは包括的な可観測性機能を実装しなければならない。

- **構造化ロギング**:
  - ログレベル: DEBUG, INFO, WARNING, ERROR, CRITICAL
  - 必須フィールド: timestamp, service_name, tenant_code, correlation_id, user_id
  - JSON形式でのログ出力（本番環境）
  - 機密情報（パスワード、APIキー）のマスキング必須
- **メトリクス**:
  - リクエスト数、レスポンスタイム、エラー率
  - ビジネスメトリクス（トランザクション数、売上等）
  - インフラメトリクス（CPU、メモリ、DB接続数）
- **分散トレーシング**:
  - すべてのリクエストに相関ID（correlation_id）を付与
  - サービス間呼び出しでIDを伝播
  - Dapr の分散トレーシング機能を活用

**根拠**: 問題の迅速な検出と診断を可能にし、システムの運用性を向上させるため。

### VIII. セキュリティファースト

**原則**: セキュリティは設計段階から組み込まれなければならない。

- **認証・認可**:
  - JWT トークンベース認証（accountサービス）
  - ターミナルAPIキー認証（terminalサービス）
  - 最小権限の原則を適用
- **データ保護**:
  - 機密データは環境変数で管理（.env ファイル、コミット禁止）
  - APIキー、パスワードはハッシュ化して保存
  - データベース接続文字列は暗号化
- **入力検証**:
  - すべてのAPI入力をPydanticスキーマで検証
  - SQL/NoSQLインジェクション対策
  - XSS対策（エスケープ処理）
- **依存関係管理**:
  - 定期的なセキュリティスキャン（pipenv check）
  - 既知の脆弱性を含むパッケージの使用禁止

**根拠**: データ漏洩やセキュリティ侵害を防止し、顧客とビジネスを保護するため。

## アーキテクチャパターン

### State Machine Pattern

**適用箇所**: Cart Service のカートライフサイクル管理

- 状態定義: initial → idle → entering_item → paying → completed/cancelled
- `cart_state_manager.py` で状態遷移を管理
- 各状態は `abstract_state.py` を継承
- 不正な状態遷移は明示的にエラー

### Plugin Architecture

**適用箇所**: Cart Service（決済方法、販促）、Report Service（レポート生成）

- プラグインは `plugins.json` で設定
- 明確なインターフェース定義（抽象基底クラス）
- プラグインの動的ロード（実行時設定変更可能）
- プラグイン間の独立性保証

### Repository Pattern

**適用箇所**: すべてのサービス

- `AbstractRepository` を継承
- データアクセスロジックをビジネスロジックから分離
- テスト時のモック化を容易に
- 一貫したCRUD操作インターフェース

## 技術制約

### 必須技術スタック

- **言語**: Python 3.12 以上
- **Webフレームワーク**: FastAPI
- **データベース**: MongoDB 7.0+（Motor async driver）
- **キャッシュ/メッセージング**: Redis
- **サービスメッシュ**: Dapr
- **コンテナ**: Docker & Docker Compose
- **依存関係管理**: Pipenv

### コード品質基準

#### 現状のツールチェーン（2025-10-12時点）

- **Linting**: flake8（各サービスの Pipfile で定義: `pipenv run lint`）
- **Formatting**: black（各サービスの Pipfile で定義: `pipenv run format`）
- **Type Checking**: mypy（各サービスの Pipfile で定義: `pipenv run typecheck`）

#### 目標ツールチェーン（ruff への移行計画）

- **Linting & Formatting**: ruff（設定ファイル: pyproject.toml）
  - **移行理由**:
    - flake8 + black より10-100倍高速（Rust製）
    - 設定の統一化（pyproject.toml に集約）
    - 自動修正機能が豊富（`--fix` フラグ）
    - メンテナンスが活発、現代的なツール
  - **移行アプローチ**:
    - サービスごとに段階的に移行（一度に全サービス変更しない）
    - 既存のテストカバレッジを維持しながら移行
    - flake8/black と ruff の設定互換性を確認
    - CI/CD パイプラインを並行運用期間を設けて更新
- **Type Checking**: mypy（継続使用）
  - ruff は型チェック機能を持たないため、mypy を継続

#### 共通基準

- **Type Hints**: すべての関数パラメータと戻り値に型ヒントを追加（必須）
- **PEP 8**: Pythonコーディング規約に準拠
- **コメント**: 英語で記述（「なぜ」を説明、「何を」はコードで表現）
- **実行方法**: `pipenv run lint`, `pipenv run format`, `pipenv run typecheck`

### ドキュメント要件

- **コードコメント・ログメッセージ**: 英語
- **主要ドキュメント**: 英語（README.md, CLAUDE.md）
- **補足ドキュメント**: 日本語可（README_ja.md）
- **変数・関数名**: 英語のみ
- **エラーメッセージ**: 英語・日本語両対応（言語コード使用）

## 開発ワークフロー

### ブランチ戦略

- **メインブランチ**: main
- **機能開発**: feature/* ブランチ
- **バグ修正**: bugfix/* ブランチ
- **緊急修正**: hotfix/* ブランチ
- main への直接コミット禁止（プルリクエスト必須）

### コミット規約

- **Conventional Commits** 形式を使用:
  - `feat:` 新機能
  - `fix:` バグ修正
  - `docs:` ドキュメント変更
  - `test:` テスト追加・修正
  - `refactor:` リファクタリング
  - `chore:` その他の変更
- コミットメッセージは英語で記述
- 1コミット = 1つの論理的変更

### コードレビュー

- すべての変更はコードレビュー必須
- 憲章違反がないか確認
- テストカバレッジの確認
- セキュリティ観点でのレビュー
- 建設的なフィードバックを提供

## パフォーマンス基準

### レスポンスタイム目標

- **API レスポンス**: 95パーセンタイルで500ms以下
- **データベースクエリ**: 平均100ms以下
- **トランザクション処理**: エンドツーエンドで2秒以内

### スケーラビリティ要件

- **同時接続**: 最低1,000同時ユーザーをサポート
- **水平スケーリング**: すべてのサービスはステートレス設計
- **データベース**: レプリカセット構成（高可用性）

## ガバナンス

### 憲章の権限

本憲章はすべての開発プラクティスに優先する。技術的判断や設計決定で迷った場合、この憲章の原則に従うこと。

### 憲章の改訂

- 憲章の変更は明示的な承認プロセスが必要
- バージョニング（セマンティックバージョニング）:
  - **MAJOR**: 後方互換性のないガバナンス変更、原則の削除・再定義
  - **MINOR**: 新しい原則・セクションの追加、既存ガイダンスの大幅な拡張
  - **PATCH**: 明確化、文言修正、タイポ修正、非意味的な改善
- 変更履歴は Sync Impact Report として文書化

### コンプライアンス検証

- すべてのプルリクエストで憲章準拠を確認
- 自動化可能なルールは CI/CD パイプラインに組み込み
- 複雑性の増加は明確な根拠と承認が必要
- 定期的なコンプライアンスレビュー（四半期ごと）

### 例外処理

- 憲章の原則に従えない場合は、明示的に文書化（ADR: Architecture Decision Records）
- 例外の理由、影響範囲、代替案を記録
- 一時的な例外には期限を設定

### ランタイムガイダンス

実装フェーズでの詳細なガイダンスは、各サービスの開発ドキュメントおよび CLAUDE.md を参照すること。

---

**Version**: 1.0.1 | **Ratified**: 2025-10-12 | **Last Amended**: 2025-10-12
