# Kugel POS バックエンドサービス アーキテクチャ

## 目次
1. [概要](#概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [サービスアーキテクチャ](#サービスアーキテクチャ)
4. [技術スタック](#技術スタック)
5. [データアーキテクチャ](#データアーキテクチャ)
6. [通信パターン](#通信パターン)
7. [セキュリティアーキテクチャ](#セキュリティアーキテクチャ)
8. [デザインパターン](#デザインパターン)
9. [デプロイメントアーキテクチャ](#デプロイメントアーキテクチャ)
10. [エラーハンドリング](#エラーハンドリング)
11. [パフォーマンスの考慮事項](#パフォーマンスの考慮事項)

## 概要

Kugel POSは、小売業向けに設計されたマイクロサービスベースのPOS（Point of Sale）バックエンドシステムです。このシステムは、ユーザー認証、端末管理、商品カタログ、ショッピングカート、売上レポート、取引ジャーナリングなど、小売業務の管理に必要な包括的な機能を提供します。

### 主な特徴
- **マイクロサービスアーキテクチャ**: 明確な境界を持つ7つの独立したサービス
- **マルチテナント対応**: データベースレベルでの各テナントの分離
- **イベント駆動型通信**: Dapr pub/subを使用した非同期メッセージング
- **RESTful API**: OpenAPIドキュメント付きのFastAPIベースのサービス
- **クラウド対応**: Azure Container Appsへのデプロイ向けに設計

## システムアーキテクチャ

### ハイレベルアーキテクチャ

```
┌─────────────────┐
│ フロントエンド  │
│  アプリケーション│
│   (POS, Web)    │
└────────┬────────┘
         │
┌────────▼────────┐
│ ロードバランサー │
│  (Azure ALB)    │
└────────┬────────┘
         │
┌────────▼────────────────────────────────────────────────┐
│           コンテナ環境 (Azure)                           │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ Account  │  │ Terminal │  │  Master  │              │
│  │ Service  │  │ Service  │  │   Data   │              │
│  │  :8000   │  │  :8001   │  │  :8002   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │   Cart   │  │  Report  │  │ Journal  │              │
│  │ Service  │  │ Service  │  │ Service  │              │
│  │  :8003   │  │  :8004   │  │  :8005   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│                                                          │
│  ┌────────────────────────────────────────┐             │
│  │        Dapr サービスメッシュ            │             │
│  └────────────────────────────────────────┘             │
└──────────────────────────────────────────────────────────┘
         │                              │
┌────────▼────────┐            ┌────────▼────────┐
│     MongoDB     │            │      Redis      │
│  (Cosmos DB)    │            │     キャッシュ   │
└─────────────────┘            └─────────────────┘
```

### サービスマップ

| サービス | ポート | 説明 | 主な責任 |
|---------|--------|------|----------|
| Account | 8000 | 認証サービス | ユーザー管理、JWTトークン生成、ロールベースのアクセス制御 |
| Terminal | 8001 | 端末管理 | 店舗/端末登録、APIキー管理、開店/閉店操作 |
| Master Data | 8002 | マスターデータサービス | 商品カタログ、支払方法、税率ルール、スタッフ管理 |
| Cart | 8003 | 取引サービス | ショッピングカート管理、支払処理、ステートマシン |
| Report | 8004 | レポートサービス | 売上レポート、日次集計、拡張可能なレポート生成 |
| Journal | 8005 | ジャーナルサービス | 電子ジャーナル、取引ログの保存と検索 |
| Stock | 8006 | 在庫管理 | 在庫追跡、在庫更新、取引処理 |

## サービスアーキテクチャ

### 1. Accountサービス
- **目的**: 集中認証と認可
- **主な機能**:
  - JWTトークンの生成と検証
  - ユーザーアカウント管理（CRUD操作）
  - ロールベースのアクセス制御
  - bcryptによるパスワードハッシュ化
- **APIエンドポイント**:
  - `POST /api/v1/accounts/token` - JWTトークン生成
  - `GET /api/v1/accounts/token/valid` - トークン検証
  - `POST /api/v1/accounts/users` - ユーザー作成
  - `GET /api/v1/accounts/users` - ユーザー一覧

### 2. Terminalサービス
- **目的**: 端末と店舗の管理
- **主な機能**:
  - 端末の登録と設定
  - APIキーの生成と検証
  - 店舗の開店/閉店操作
  - 現金入出金管理
- **APIエンドポイント**:
  - `POST /api/v1/terminals/register` - 端末登録
  - `POST /api/v1/terminals/open` - 開店
  - `POST /api/v1/terminals/close` - 閉店
  - `POST /api/v1/terminals/cash-in-out` - 現金操作
- **発行イベント**:
  - `opencloselog_report` - 開店/閉店イベント
  - `cashlog_report` - 現金入出金イベント

### 3. Master Dataサービス
- **目的**: 集中マスターデータ管理
- **主な機能**:
  - 商品カタログ管理
  - カテゴリー管理
  - 支払方法設定
  - 税率ルール管理
  - スタッフマスターデータ
  - 店舗別価格設定
- **データモデル**:
  - `ItemCommonMaster` - グローバル商品情報
  - `ItemStoreMaster` - 店舗別商品データ
  - `PaymentMaster` - 支払方法設定
  - `TaxMaster` - 税計算ルール
  - `StaffMaster` - 従業員情報

### 4. Cartサービス
- **目的**: ショッピングカートと取引処理
- **主な機能**:
  - ステートマシンベースのカートライフサイクル
  - 税計算を含む明細管理
  - プラグインアーキテクチャによる支払処理
  - レシート生成
  - 取消/返品操作
- **ステートマシン**:
  ```
  initial → idle → entering_item → paying → completed
                ↘               ↗        ↘ cancelled
  ```
- **プラグインシステム**:
  - 支払方法（現金、キャッシュレス、その他）
  - 販売促進
  - レシートデータカスタマイズ
- **発行イベント**:
  - `tranlog_report` - レポート用取引ログ
  - `tranlog_status` - 取引ステータス更新

### 5. Reportサービス
- **目的**: 売上レポートと分析
- **主な機能**:
  - 日次売上レポート
  - 端末別レポート
  - 時間別集計
  - プラグインベースのレポート生成
- **レポートタイプ**:
  - 日次売上集計
  - 端末レポート
  - 時間別レポート
  - プラグインによるカスタムレポート

### 6. Journalサービス
- **目的**: 電子ジャーナルと監査証跡
- **主な機能**:
  - 取引ログ保存
  - 検索・取得API
  - ページネーション対応
  - 時間ベースのクエリ
- **データタイプ**:
  - 取引ログ
  - 現金入出金ログ
  - 開店/閉店ログ

### 7. Stockサービス
- **目的**: 在庫管理と在庫追跡
- **主な機能**:
  - リアルタイム在庫追跡
  - 競合状態を防ぐアトミックな在庫更新
  - 取引ベースの在庫更新
  - 監査用の在庫スナップショット
  - マルチストア在庫サポート
- **APIエンドポイント**:
  - `GET /api/v1/tenants/{tenant_id}/stores/{store_code}/stock` - 全在庫品目の取得
  - `GET /api/v1/tenants/{tenant_id}/stores/{store_code}/stock/{item_code}` - 特定品目の在庫取得
  - `PUT /api/v1/tenants/{tenant_id}/stores/{store_code}/stock/{item_code}/update` - 在庫数量の更新
  - `POST /api/v1/tenants/{tenant_id}/stores/{store_code}/stock/snapshot` - 在庫スナップショット作成
  - `GET /api/v1/tenants/{tenant_id}/stores/{store_code}/stock/snapshot` - 在庫スナップショット取得
- **サブスクライブするイベント**:
  - `tranlog_report` - 取引に基づいた在庫更新

## 技術スタック

### コア技術
- **言語**: Python 3.12+
- **Webフレームワーク**: FastAPI
- **ASGIサーバー**: Uvicorn
- **データベース**: MongoDB 7.0+
- **キャッシュ**: Redis
- **サービスメッシュ**: Dapr
- **コンテナ**: Docker
- **オーケストレーション**: Docker Compose / Azure Container Apps

### 主要ライブラリ
- **Motor**: 非同期MongoDBドライバー
- **Pydantic**: データ検証とシリアライゼーション
- **Beanie**: MongoDB ODM
- **PyJWT**: JWTトークン処理
- **Bcrypt**: パスワードハッシュ化
- **Httpx**: 非同期HTTPクライアント
- **Pytest**: テストフレームワーク

### 開発ツール
- **Pipenv**: 依存関係管理
- **Ruff**: リンティングとフォーマット
- **Pytest-asyncio**: 非同期テストサポート
- **Coverage.py**: コードカバレッジ

## データアーキテクチャ

### データベース設計
- **マルチテナントアーキテクチャ**: 各テナントは個別のMongoDBデータベースを持つ
- **データベース命名規則**: `{service_name}_{tenant_code}`
- **コレクション命名**: スネークケース（例：`item_master`、`transaction_log`）

### ドキュメントモデル
すべてのドキュメントは以下を提供する`BaseDocumentModel`を継承：
- `id`: 一意識別子
- `created_at`: 作成タイムスタンプ
- `updated_at`: 最終更新タイムスタンプ
- `created_by`: レコードを作成したユーザー
- `updated_by`: 最後に更新したユーザー

### データフロー
```
フロントエンド → APIゲートウェイ → サービス → リポジトリ → MongoDB
                                      ↓
                                ステートストア (Redis)
                                      ↓
                                  Pub/Sub (Redis)
```

## 通信パターン

### 同期通信
- **REST API**: 統一されたHTTPクライアントを使用したサービス間通信
- **HttpClientHelper**: すべてのサービス間REST呼び出しがこの統一クライアントを使用
  - 自動リトライメカニズム（デフォルト：3回試行）
  - サーキットブレーカーパターンの実装
  - パフォーマンス向上のためのコネクションプーリング
  - サービスディスカバリサポート
- **認証**: APIキーフォールバック付きJWTトークン
- **APIバージョニング**: すべてのAPIは`/api/v1/`でバージョン管理

### 非同期通信
- **イベント駆動**: RedisストリームによるDapr pub/sub
- **DaprClientHelper**: すべてのDapr操作用の統一クライアント
  - 内蔵サーキットブレーカー（3回失敗でトリガー、60秒回復）
  - HttpClientHelper経由の自動リトライ
  - ノンブロッキングエラーハンドリング
- **トピック**:
  - `tranlog_report`: レポート用取引データ
  - `tranlog_status`: 取引ステータス更新
  - `cashlog_report`: 現金入出金イベント
  - `opencloselog_report`: 端末開店/閉店イベント

### ステート管理
- **Daprステートストア**: Redisベースのステート管理
- **統一アクセス**: 一貫性のためDaprClientHelper経由
- **使用例**:
  - カートサービスの端末キャッシュ
  - 日次カウンター管理
  - 取引ステータス追跡
  - 冪等性キーの保存

## セキュリティアーキテクチャ

### 認証
- **JWTトークン**: Accountサービスによる発行
- **トークン検証**: 各サービスが独立してトークンを検証
- **トークン有効期限**: 設定可能な有効期限

### 認可
- **ロールベースアクセス制御**: JWTクレームに定義されたユーザーロール
- **APIキー認証**: 端末固有のAPIキー
- **マルチテナンシー**: データベースレベルでのテナント分離

### セキュリティベストプラクティス
- bcryptによるパスワードハッシュ化
- 保存前のAPIキーハッシュ化
- 環境変数ベースの設定
- コードやログに秘密情報を含めない

## デザインパターン

### 1. ステートマシンパターン（Cartサービス）
```python
class CartStateManager:
    states = {
        'initial': InitialState(),
        'idle': IdleState(),
        'entering_item': EnteringItemState(),
        'paying': PayingState(),
        'completed': CompletedState(),
        'cancelled': CancelledState()
    }
```

### 2. プラグインアーキテクチャ
- **支払方法**: 拡張可能な支払処理
- **販売促進**: プラグ可能な促進ルール
- **レポート生成**: カスタムレポート形式

### 3. リポジトリパターン
```python
class AbstractRepository:
    async def create(self, document: T) -> T
    async def find_by_id(self, id: str) -> Optional[T]
    async def update(self, id: str, document: T) -> Optional[T]
    async def delete(self, id: str) -> bool
```

### 4. サーキットブレーカーパターン
- **実装**: HttpClientHelperとDaprClientHelperに組み込み
- **状態**: Closed → Open → Half-Open
- **設定**:
  - 失敗閾値: 3回連続失敗
  - 回復タイムアウト: 60秒
  - すべてのHTTPおよびDapr操作に適用
- **利点**:
  - カスケード障害の防止
  - 利用不可能なサービスの高速フェイル
  - 自動回復試行

### 5. ストラテジーパターン
- 支払処理戦略
- 税計算戦略
- レシート生成戦略

## デプロイメントアーキテクチャ

### ローカル開発
```yaml
# Docker Compose設定
services:
  mongodb:
    image: mongo:7.0
    command: ["--replSet", "rs0"]
  
  redis:
    image: redis:7-alpine
  
  account:
    build: ./account
    ports: ["8000:8000"]
```

### 本番環境（Azure）
- **Azure Container Apps**: サーバーレスコンテナホスティング
- **Azure Cosmos DB**: MongoDB互換データベース
- **Azure Redis Cache**: マネージドRedisサービス
- **Azure Load Balancer**: トラフィック分散
- **Azure Container Registry**: コンテナイメージストレージ

### 環境設定
1. Docker Compose環境変数
2. サービス固有の.envファイル
3. 設定クラスのデフォルト値
4. 優先順位: 環境変数 > .env > デフォルト

## エラーハンドリング

### エラーコード構造
形式: `XXYYZZ`
- `XX`: サービス識別子
- `YY`: 機能/モジュール識別子
- `ZZ`: 特定のエラー番号

### サービスエラー範囲
- `10xx`: 一般エラー
- `20xx`: 認証エラー
- `30xx`: 検証エラー
- `401xx-404xx`: カートサービス
- `405xx`: マスターデータサービス
- `406xx-407xx`: 端末サービス
- `408xx-409xx`: アカウントサービス
- `410xx-411xx`: ジャーナルサービス
- `412xx-413xx`: レポートサービス

### エラーレスポンス形式
```json
{
  "success": false,
  "code": "401001",
  "message": "カートが見つかりません",
  "data": null
}
```

## パフォーマンスの考慮事項

### キャッシング戦略
- **Redisキャッシュ**: 端末情報、マスターデータ
- **インメモリキャッシュ**: 頻繁にアクセスされる設定
- **キャッシュ無効化**: イベント駆動のキャッシュ更新

### データベース最適化
- **インデックス**: 頻繁にクエリされるフィールドに作成
- **集約パイプライン**: 複雑なクエリに使用
- **コネクションプーリング**: Motor非同期接続管理

### 非同期操作
- すべてのデータベース操作は非同期
- 全体的なノンブロッキングI/O
- 並行リクエスト処理

### スケーラビリティ
- ステートレスサービス（カート状態を除く）
- コンテナオーケストレーションによる水平スケーリング
- テナント別データベースシャーディング
- 疎結合のためのイベント駆動アーキテクチャ

## モニタリングと可観測性

### ロギング
- 相関IDを含む構造化ロギング
- ログレベル: DEBUG、INFO、WARNING、ERROR
- リクエスト/レスポンスロギングミドルウェア
- 集中ログ収集

### ヘルスチェック
- 各サービスの`/health`エンドポイント
- データベース接続チェック
- Redis接続チェック
- 依存関係ヘルスモニタリング

### メトリクス
- リクエストレイテンシー
- エラー率
- 取引量
- リソース使用率

## 開発ワークフロー

### コード構成
```
service/
├── app/
│   ├── api/          # APIエンドポイント
│   ├── config/       # 設定
│   ├── models/       # データモデル
│   ├── services/     # ビジネスロジック
│   └── main.py       # アプリケーションエントリ
├── tests/            # テストファイル
├── Pipfile           # 依存関係
└── Dockerfile        # コンテナ定義
```

### テスト戦略
- ビジネスロジックの単体テスト
- APIの統合テスト
- テストデータベースを使用したリポジトリテスト
- pytest-asyncioによる非同期テストサポート

### CI/CDパイプライン
1. コードコミットがビルドをトリガー
2. テストとリンティングの実行
3. Dockerイメージのビルド
4. コンテナレジストリへのプッシュ
5. ステージングへのデプロイ
6. 統合テストの実行
7. 本番環境へのデプロイ
