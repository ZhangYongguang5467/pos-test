# ジャーナルサービス モデル仕様

## 概要

ジャーナルサービスは、Kugel POSプラットフォームの電子ジャーナルおよびトランザクションログストレージシステムとして機能します。すべてのPOS操作の永続的で検索可能な記録保持者として機能し、生のトランザクションデータを人間が読める形式のジャーナルエントリとレシートに変換します。サービスは、二重ストレージパターン、冪等性保証を備えた洗練されたイベント処理、および監査コンプライアンスのための包括的な検索機能を実装しています。すべての操作は、エンタープライズグレードのデータ整合性と規制遵守機能を備えたマルチテナント分離用に設計されています。

## データベースドキュメントモデル

すべてのドキュメントモデルは、監査、キャッシュ、シャーディング用の共通フィールドを提供する`AbstractDocument`を継承しています。

### AbstractDocument（基底クラス）

すべてのドキュメントに共通機能を提供する基底クラス。

**基底フィールド:**

| フィールド名 | 型 | 必須 | 説明 |
|------------|------|----------|-------------|
| shard_key | string | - | 水平スケーリング用のデータベースシャーディングキー |
| created_at | datetime | - | ドキュメント作成タイムスタンプ |
| updated_at | datetime | - | 最終更新タイムスタンプ |
| cached_on | datetime | - | キャッシュ無効化用のキャッシュタイムスタンプ |
| etag | string | - | 楽観的並行性制御用のエンティティタグ |

### 1. JournalDocument（プライマリジャーナルストレージ）

検索可能でフォーマット済みコンテンツを含む電子ジャーナルエントリを保存するためのメインドキュメント。

**コレクション名:** `journal`

**目的:** 検索可能で人間が読める形式ですべてのPOS操作の統合ストレージ

**フィールド定義:**

| フィールド名 | 型 | 必須 | 説明 |
|------------|------|----------|-------------|
| tenant_id | string | ✓ | テナント識別子 |
| store_code | string | ✓ | 店舗コード |
| terminal_no | integer | ✓ | ターミナル番号 |
| transaction_no | string | - | トランザクション番号（非売上操作の場合null） |
| transaction_type | integer | ✓ | トランザクションタイプコード（101=売上、401=現金入金など） |
| business_date | string | ✓ | ビジネス日付（YYYYMMDD形式） |
| open_counter | integer | - | ターミナルセッションカウンタ |
| business_counter | integer | - | 日次ビジネス操作カウンタ |
| receipt_no | integer | - | 売上トランザクション用のレシート番号 |
| amount | float | - | トランザクション金額（操作タイプに基づく正/負） |
| quantity | integer | - | 売上トランザクション用の総アイテム数量 |
| staff_id | string | - | 操作を実行したスタッフ識別子 |
| user_id | string | - | ユーザー識別子（レガシーフィールド、通常null） |
| generate_date_time | string | ✓ | ジャーナル作成の実際のタイムスタンプ（ISO形式） |
| journal_text | string | ✓ | 監査表示用の人間が読める形式のジャーナルエントリ |
| receipt_text | string | - | 印刷用のフォーマット済みレシートコンテンツ |

**インデックス:**
- ユニーク複合インデックス: (tenant_id, store_code, terminal_no, transaction_type, generate_date_time)
- 複合インデックス: (tenant_id, store_code, business_date)
- 複合インデックス: (tenant_id, store_code, terminal_no, business_date)
- インデックス: transaction_type
- インデックス: receipt_no
- テキストインデックス: journal_text（キーワード検索用）
- インデックス: generate_date_time

### 2. CashInOutLog（現金操作記録）

ターミナルサービスからの現金移動操作ログを保存するドキュメント。

**コレクション名:** `log_cash_in_out`

**目的:** 非売上現金移動の詳細記録（釣り銭準備金、入金、支払い）

**フィールド定義:**

| フィールド名 | 型 | 必須 | 説明 |
|------------|------|----------|-------------|
| tenant_id | string | ✓ | テナント識別子 |
| store_code | string | ✓ | 店舗コード |
| store_name | string | - | 店舗表示名 |
| terminal_no | integer | ✓ | ターミナル番号 |
| staff_id | string | - | 操作を実行したスタッフ識別子 |
| staff_name | string | - | スタッフ表示名 |
| business_date | string | ✓ | ビジネス日付（YYYYMMDD） |
| open_counter | integer | ✓ | ターミナルセッションカウンタ |
| business_counter | integer | ✓ | ビジネス操作カウンタ |
| generate_date_time | string | ✓ | イベントタイムスタンプ（ISO形式） |
| amount | float | ✓ | 操作金額（現金入金は正、現金出金は負） |
| description | string | - | 操作理由/説明 |
| receipt_text | string | - | フォーマット済みレシートテキスト |
| journal_text | string | - | フォーマット済みジャーナルテキスト |

**インデックス:**
- 複合インデックス: (tenant_id, store_code, terminal_no, business_date)
- インデックス: amount

### 3. OpenCloseLog（ターミナルセッション記録）

ターミナルサービスからのターミナル開店/閉店操作ログを保存するドキュメント。

**コレクション名:** `log_open_close`

**目的:** トランザクション数照合を含むターミナルセッション境界の記録

**フィールド定義:**

| フィールド名 | 型 | 必須 | 説明 |
|------------|------|----------|-------------|
| tenant_id | string | ✓ | テナント識別子 |
| store_code | string | ✓ | 店舗コード |
| store_name | string | - | 店舗表示名 |
| terminal_no | integer | ✓ | ターミナル番号 |
| staff_id | string | - | 操作を実行したスタッフ識別子 |
| staff_name | string | - | スタッフ表示名 |
| business_date | string | ✓ | ビジネス日付（YYYYMMDD） |
| open_counter | integer | ✓ | ターミナルセッションカウンタ |
| business_counter | integer | ✓ | ビジネス操作カウンタ |
| operation | string | ✓ | 操作タイプ（'open'または'close'） |
| generate_date_time | string | ✓ | イベントタイムスタンプ（ISO形式） |
| terminal_info | TerminalInfoDocument | - | 完全なターミナル設定スナップショット |
| cart_transaction_count | integer | - | セッション内のトランザクション数（closeのみ） |
| cart_transaction_last_no | integer | - | 最後のトランザクション番号（closeのみ） |
| cash_in_out_count | integer | - | セッション内の現金操作数（closeのみ） |
| cash_in_out_last_datetime | string | - | 最後の現金操作タイムスタンプ（closeのみ） |
| receipt_text | string | - | フォーマット済みレシートテキスト |
| journal_text | string | - | フォーマット済みジャーナルテキスト |

**インデックス:**
- 複合インデックス: (tenant_id, store_code, terminal_no, business_date, open_counter)
- インデックス: operation

### 4. トランザクションログ（kugel_commonから）

トランザクションデータはkugel_commonライブラリの`BaseTransaction`を参照します。

**コレクション名:** `log_tran`

**目的:** サービス間検証用の完全なトランザクション記録への参照

**使用される主要フィールド:**
- 明細項目、支払い、税金を含む完全なトランザクション記録
- 適切な分類のためのトランザクションタイプコード
- セッション追跡のためのビジネス日付とカウンタ情報
- 照合のための金額と数量の合計

## トランザクションタイプインテリジェンス

### 自動トランザクションタイプ変換

サービスは知的なトランザクションタイプ処理を実装します：

**売上トランザクション:**
- 通常売上（101）→ `is_cancelled=true`の場合、取消売上（-101）
- 返品売上（102）→ 負の要因で処理
- 売上取消（201）→ 取消ロジックで処理
- 返品取消（202）→ 返品取消ロジックで処理

**現金操作:**
- 現金金額 > 0 → 現金入金（401）
- 現金金額 < 0 → 現金出金（402）

**ターミナル操作:**
- ターミナル'open'操作 → 開店（301）
- ターミナル'close'操作 → 閉店（302）

**レポート操作:**
- フラッシュレポート → フラッシュレポート（701）
- 日次レポート → 日次レポート（702）

## APIリクエスト/レスポンススキーマ

すべてのスキーマは、JSON直列化の際にsnake_caseからcamelCaseへの自動変換を提供する`BaseSchemaModel`を継承しています。

### リクエストスキーマ

#### CreateJournalRequest

手動ジャーナルエントリ作成リクエスト。

| フィールド名（JSON） | 型 | 必須 | 説明 |
|-------------------|------|----------|-------------|
| transactionNo | string | - | トランザクション番号（非売上の場合オプション） |
| transactionType | integer | ✓ | トランザクションタイプコード |
| businessDate | string | ✓ | ビジネス日付（YYYYMMDD） |
| openCounter | integer | - | ターミナルセッションカウンタ |
| businessCounter | integer | - | ビジネス操作カウンタ |
| receiptNo | integer | - | レシート番号 |
| amount | float | - | トランザクション金額 |
| quantity | integer | - | アイテム数量 |
| staffId | string | - | スタッフ識別子 |
| userId | string | - | ユーザー識別子（レガシー） |
| journalText | string | ✓ | 人間が読める形式のジャーナルエントリ |
| receiptText | string | - | フォーマット済みレシートテキスト |

#### SearchJournalRequest（クエリパラメータ）

広範囲なフィルタリング機能を備えたジャーナル検索パラメータ。

| フィールド名（JSON） | 型 | 必須 | 説明 |
|-------------------|------|----------|-------------|
| terminalNo | string | - | カンマ区切りのターミナル番号 |
| transactionType | string | - | カンマ区切りのトランザクションタイプコード |
| businessDateFrom | string | - | 開始ビジネス日付（YYYYMMDD） |
| businessDateTo | string | - | 終了ビジネス日付（YYYYMMDD） |
| generateDateFrom | string | - | 開始生成日付（YYYY-MM-DD） |
| generateDateTo | string | - | 終了生成日付（YYYY-MM-DD） |
| receiptNoFrom | integer | - | 開始レシート番号 |
| receiptNoTo | integer | - | 終了レシート番号 |
| keyword | string | - | ジャーナルテキスト内のキーワード検索 |
| skip | integer | - | ページネーションオフセット（デフォルト: 0） |
| limit | integer | - | ページサイズ（デフォルト: 100、最大: 100） |
| sort | string | - | ソート条件（形式: "field:direction"） |

#### DirectTransactionRequest

レガシー互換性のための直接トランザクション送信。

| フィールド名（JSON） | 型 | 必須 | 説明 |
|-------------------|------|----------|-------------|
| transactionNo | string | ✓ | トランザクション番号 |
| transactionType | integer | ✓ | トランザクションタイプコード |
| businessDate | string | ✓ | ビジネス日付（YYYYMMDD） |
| openCounter | integer | ✓ | ターミナルセッションカウンタ |
| businessCounter | integer | ✓ | ビジネス操作カウンタ |
| receiptNo | integer | ✓ | レシート番号 |
| amount | float | ✓ | トランザクション金額 |
| quantity | integer | - | アイテム数量 |
| staffId | string | - | スタッフ識別子 |
| userId | string | - | ユーザー識別子 |
| receiptText | string | - | レシートテキスト |
| journalText | string | ✓ | ジャーナルテキスト |

### レスポンススキーマ

#### JournalResponse

個別ジャーナルエントリレスポンス形式。

| フィールド名（JSON） | 型 | 説明 |
|-------------------|------|-------------|
| journalId | string | ジャーナルエントリ一意識別子 |
| tenantId | string | テナント識別子 |
| storeCode | string | 店舗コード |
| terminalNo | integer | ターミナル番号 |
| transactionNo | string | トランザクション番号（非売上の場合null） |
| transactionType | integer | トランザクションタイプコード |
| transactionTypeName | string | 人間が読める形式のトランザクションタイプ |
| businessDate | string | ビジネス日付（YYYYMMDD） |
| openCounter | integer | ターミナルセッションカウンタ |
| businessCounter | integer | ビジネス操作カウンタ |
| receiptNo | integer | レシート番号 |
| amount | float | トランザクション金額 |
| quantity | integer | アイテム数量 |
| staffId | string | スタッフ識別子 |
| userId | string | ユーザー識別子 |
| generateDateTime | string | ジャーナル作成タイムスタンプ |
| journalText | string | 人間が読める形式のジャーナルエントリ |
| receiptText | string | フォーマット済みレシートテキスト |

#### JournalListResponse

ページネーション済みジャーナル検索結果。

| フィールド名（JSON） | 型 | 説明 |
|-------------------|------|-------------|
| items | array[JournalResponse] | ジャーナルエントリ |
| total | integer | 条件に一致する総数 |
| skip | integer | ページネーションオフセット |
| limit | integer | ページサイズ |

#### EventAcknowledgement

Pub/subイベント処理確認。

| フィールド名（JSON） | 型 | 説明 |
|-------------------|------|-------------|
| success | boolean | 処理ステータス |
| eventId | string | イベント識別子 |
| message | string | ステータスメッセージ |

## イベント駆動アーキテクチャ

### Dapr Pub/Sub統合

サービスは、堅牢な冪等性とエラー処理を備えた3つの重要なイベントストリームを購読します：

#### トランザクションログイベント（`topic-tranlog`）
- **ソース**: カートサービス
- **エンドポイント**: `/api/v1/tranlog`
- **コンテンツ**: 明細項目、支払い、税金を含む完全なトランザクションデータ
- **処理**: トランザクションログと統合ジャーナルエントリの両方を作成

#### 現金ログイベント（`topic-cashlog`）
- **ソース**: ターミナルサービス  
- **エンドポイント**: `/api/v1/cashlog`
- **コンテンツ**: 金額と説明を含む現金入出金操作
- **処理**: 現金操作ログと対応するジャーナルエントリを作成

#### 開閉ログイベント（`topic-opencloselog`）
- **ソース**: ターミナルサービス
- **エンドポイント**: `/api/v1/opencloselog`
- **コンテンツ**: トランザクション数照合を含むターミナルセッションイベント
- **処理**: セッションログとターミナル操作ジャーナルエントリを作成

### 冪等イベント処理

**重複防止戦略:**
- **ステートストア追跡**: 処理済みイベントIDを追跡するためにDaprステートストアを使用
- **一意イベントID**: 各イベントはグローバルに一意の識別子を持つ必要がある
- **サーキットブレーカーパターン**: 外部サービス障害を適切に処理
- **リトライロジック**: 一時的な障害の自動リトライ
- **ヘルスチェックフィルタリング**: ヘルスチェックイベントを無視

**処理フロー:**
1. Dapr pub/sub経由でイベントを受信
2. 以前の処理のためにDaprステートストアをチェック
3. 未処理の場合、ログエントリとジャーナルエントリを原子的に作成
4. ステートストアでイベントを処理済みとしてマーク
5. 処理ステータスで確認応答を送信

### 原子的トランザクション処理

**MongoDBトランザクションパターン:**
```python
async with await self.db.client.start_session() as session:
    async with session.start_transaction():
        # 専用ログエントリを作成（トランザクション/現金/開閉）
        log_result = await log_collection.insert_one(log_data, session=session)
        
        # 統合ジャーナルエントリを作成
        journal_result = await journal_collection.insert_one(journal_data, session=session)
        
        # イベントを処理済みとしてマーク
        await state_store.save_state(event_id, processed_data, session=session)
```

## 二重ストレージアーキテクチャ

### ストレージパターンの根拠

ジャーナルサービスは洗練された二重ストレージパターンを実装します：

**1. 専門ログストレージ**
- タイプ固有のコレクション（`log_tran`、`log_cash_in_out`、`log_open_close`）
- サービス固有の処理のための詳細な運用データ
- サービス間検証と照合

**2. 統合ジャーナルストレージ**
- すべての操作用の単一`journal`コレクション
- 標準化された検索可能な形式
- 人間が読める監査証跡

### 二重ストレージの利点

**運用効率:**
- タイプ固有のコレクションでの専門クエリ
- すべての操作タイプにわたる統合検索
- データタイプごとの最適化されたインデックス戦略

**データ整合性:**
- ログとジャーナル間のクロス参照検証
- 原子的作成により一貫性を保証
- 包括的な監査証跡の保持

**検索パフォーマンス:**
- 検索操作用に最適化されたジャーナルコレクション
- 運用クエリ用に最適化されたログコレクション
- キーワード検索機能のためのテキストインデックス

## 高度な検索機能

### 検索機能

**マルチフィールドフィルタリング:**
- ターミナル番号範囲
- トランザクションタイプカテゴリ
- ビジネス日付範囲
- 生成タイムスタンプ範囲
- レシート番号範囲

**テキスト検索:**
- MongoDBテキストインデックスを使用したジャーナルテキスト内のキーワード検索
- 大文字小文字を区別しないマッチング
- 関連性スコアリング
- 正規表現パターンサポート

**柔軟なソート:**
- マルチフィールドソート
- 昇順/降順方向制御
- 日付ベースのデフォルトソート

**ページネーションサポート:**
- 設定可能なページサイズ（最大100）
- 総数メタデータ
- 効率的なskip/limit実装

### 検索最適化

**インデックス戦略:**
- 一般的なクエリパターン用の複合インデックス
- 全文検索用のテキストインデックス
- 範囲クエリ用の日付ベースインデックス
- データ整合性用の一意インデックス

**パフォーマンス考慮事項:**
- 大規模データセット用の投影制限
- インデックス使用の最適化
- クエリプランの分析と最適化

## マルチテナンシーとセキュリティ

### データベース分離

**テナント分離:**
- 各テナントは別々のデータベースを使用: `db_journal_{tenant_id}`
- テナント間の完全なデータ分離
- すべての操作でのテナント検証
- テナント識別子でのシャードキープレフィックス

**テナントごとのコレクション構造:**
各テナントデータベースには同一のコレクション構造が含まれます：
- `journal`: 統合ジャーナルエントリ
- `log_tran`: トランザクションログ
- `log_cash_in_out`: 現金操作ログ
- `log_open_close`: ターミナルセッションログ

### 認証と認可

**二重認証サポート:**
- **JWTトークン**: 管理アクセス用のプライマリ認証
- **APIキー**: ターミナル操作とレガシー互換性
- **サービス間**: サービストークンを使用したサービス間通信

**認可レベル:**
- **管理**: 完全なジャーナル検索と管理
- **ターミナル**: 特定ターミナル用のジャーナルエントリ作成
- **サービス**: イベント処理用のサービス間通信

**セキュリティ検証:**
- テナントIDパス検証
- ターミナルアクセス制限
- スタッフ/ユーザー認可チェック

### データ保護

**監査コンプライアンス:**
- 不変のジャーナルエントリ（更新不可）
- 完全な操作履歴の保持
- 規制遵守サポート
- 改ざん防止記録保持

**アクセス制御:**
- テナント間データアクセスなし
- 操作レベル認可
- 包括的な監査証跡
- セキュアなイベント処理

## 外部サービス統合

### サービス通信

**ジャーナルステータス通知:**
イベントが処理される際、サービスは以下を使用して元のサービスにステータスコールバックを送信します：
- **サービス間JWTトークン** 認証用
- **サーキットブレーカーパターン** 障害回復性用
- **HTTPクライアントヘルパー** リトライロジック付き
- **通知エンドポイント** ソースサービス内

**通知コンテンツ:**
- イベント処理ステータス（成功/失敗）
- 相関用イベントID
- 失敗処理用エラー詳細
- タイムスタンプ情報

### エラー処理とモニタリング

**例外階層:**
構造化されたエラーコード（410xxx形式）：
- **410001-410007**: ジャーナル操作
- **410101-410105**: 検証エラー
- **411001-411006**: 外部サービス問題

**ヘルスモニタリング:**
マルチコンポーネントヘルスチェック：
- MongoDBの接続性とレプリカセットステータス
- Daprサイドカー接続性
- ステートストアの可用性
- イベント処理キューステータス

**重大障害通知:**
- 重大障害のSlack統合
- 通知内の詳細なエラーコンテキスト
- サービス識別とエラー相関
- デバッグ用の元のトランザクションデータ

## パフォーマンス考慮事項

### シャーディング戦略

**インテリジェントシャーディング:**
すべてのドキュメントは複合シャードキーを使用：
```
shard_key = tenant_id + store_code + terminal_no + business_date
```

**利点:**
- テナント/店舗/ターミナル境界にわたる負荷分散
- ビジネス日付範囲内のクエリ最適化
- 効率的なデータアーカイブ戦略の実現
- 水平スケーリングサポート

### クエリ最適化

**インデックス設計:**
- クエリパターンに合わせた複合インデックス
- 全文検索要件用のテキストインデックス
- 時間的クエリ用の日付範囲インデックス
- データ整合性制約用の一意インデックス

**クエリパフォーマンス:**
- 大規模結果セット用の投影最適化
- インデックス付きskip/limitによるページネーション効率
- インデックスを使用したソート操作最適化
- クエリプランの分析とモニタリング

### キャッシュ戦略

**ステートストアキャッシュ:**
- イベント処理ステータスキャッシュ
- TTL付き重複防止
- サーキットブレーカー状態管理
- パフォーマンスメトリクスキャッシュ

## 検証ルール

### ジャーナルエントリ検証

**ビジネスルール:**
- トランザクションタイプは列挙からの有効コードである必要
- ビジネス日付は有効なYYYYMMDD形式である必要
- すべてのエントリにジャーナルテキストが必須で非空
- 返品/取消/現金出金操作では金額が負も可能
- レシート番号はターミナル/ビジネス日付スコープ内で一意である必要

**データ整合性:**
- イベントIDはグローバルに一意である必要
- タイムスタンプは有効なISO形式である必要
- トランザクションタイプに基づく必須フィールド検証
- ログとジャーナルエントリ間のクロス参照検証

### 検索リクエスト検証

**パラメータ検証:**
- 日付範囲は論理的である必要（終了日 ≥ 開始日）
- ターミナル番号は有効な整数である必要
- トランザクションタイプは有効な列挙値である必要
- ページネーション制限の強制（ページあたり最大100）
- ソートフィールドは有効なドキュメントフィールドである必要

**セキュリティ検証:**
- テナントアクセス認可
- ターミナルアクセス制限
- 大規模データセット用の日付範囲制限
- クエリ複雑性制限

## データアーカイブとライフサイクル

### 記録保持

**不変性保証:**
- ジャーナルエントリは作成後に変更不可
- ジャーナルコレクションでの更新操作サポートなし
- 監査証跡整合性の永続的保持
- 不変記録による規制遵守

**アーカイブ戦略:**
- ビジネス日付ベースのパーティショニングにより効率的なアーカイブが可能
- テナントごとの設定可能な保持ポリシー
- 長期ストレージへの自動アーカイブ
- 履歴データの圧縮ストレージ

### データライフサイクル管理

**アクティブデータ:**
- プライマリコレクション内の現在および最近のビジネス日付
- 運用クエリ用の最適化されたインデックス
- 利用可能な完全な検索機能

**アーカイブデータ:**
- アーカイブコレクションに移動された履歴データ
- 制限された検索機能での読み取り専用アクセス
- 延長保持期間での圧縮ストレージ
- コンプライアンス駆動の保持スケジュール

この包括的なモデル仕様は、洗練されたイベント処理、堅牢なデータ整合性、包括的な検索機能、規制遵守機能を備えたエンタープライズグレードのトランザクションログシステムとしてのジャーナルサービスの役割を実証しています。二重ストレージパターン、冪等イベント処理、マルチテナントアーキテクチャは、POSの監査証跡管理のためのスケーラブルで信頼性の高い基盤を提供します。